(function(){'use strict';(function(a){var b=Math.max;a=a&&a.hasOwnProperty('default')?a['default']:a;var c=function(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')},d=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),e=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:function(){};c(this,a),this.width=b.width,this.height=b.height,this.maxMoveIterations=b.maxMoveIterations||1,this.allowFallbackResize=!!b.allowFallbackResize,this.nodes=d,this.onchange=e,this.saveUpdate()}return d(a,[{key:'canAddNode',value:function(a){if(!this.isPositionValid(a.x,a.y,a.width,a.height))return!1;var b,c=this.cloneGrid();b=c.addNode(Object.assign({},a));var d=c.getChangesForMove(b,b.x,b.y,b.width,b.height);return!!d}},{key:'addNode',value:function(a){var c=Math.min;return a=this._prepareNode(a),a.maxWidth&&(a.width=c(a.width,a.maxWidth)),a.maxHeight&&(a.height=c(a.height,a.maxHeight)),a.minWidth&&(a.width=b(a.width,a.minWidth)),a.minHeight&&(a.height=b(a.height,a.minHeight)),a._dirty=!0,this.nodes.push(a),this.triggerChangeEvent(),a}},{key:'moveNode',value:function(a,b,c,d,e){var f,g=this;if(f=this.getChangesForMove(a,b,c,d,e),!!f)return f.forEach(function(a){var b=g.nodes.find(function(b){return b.id===a.id});b&&g.setNewPosition(b,a.x,a.y,a.width,a.height)}),this.triggerChangeEvent(),!0}},{key:'removeNode',value:function(a){a&&(a.id=null,this.nodes=this.nodes.filter(function(b){return b!==a}),this.triggerChangeEvent(a))}},{key:'getNodeById',value:function(a){return this.nodes.find(function(b){return a===b.id})}},{key:'cleanNodes',value:function(){this.nodes.forEach(function(a){a._dirty=!1})}},{key:'getDirtyNodes',value:function(){return this.nodes.filter(function(a){return a._dirty})}},{key:'isPositionValid',value:function(a,b,c,d){var e=!0;return(0>b||0>a||b+d>this.height||a+c>this.width)&&(e=!1),e}},{key:'whatIsHere',value:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;return this.nodes.filter(function(e){return!(e.x+e.width<=a||a+c<=e.x||e.y+e.height<=b||b+d<=e.y)})}},{key:'isAreaEmpty',value:function(a,b,c,d,e){if(!this.isPositionValid(a,b,c,d))return!1;var f=this.whatIsHere(a,b,c,d);return e&&(f=f.filter(function(a){return a!==e})),!f.length}},{key:'findFreeSpace',value:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,c=arguments[2],d=null,e=void 0,f=void 0;for(e=0;e<=this.width-a&&!d;e++)for(f=0;f<=this.height-b&&!d;f++)this.isAreaEmpty(e,f,a,b,c)&&(d={x:e,y:f,w:a,h:b});return d}},{key:'isNodeChangedPosition',value:function(a,b,c,d,e){return a.x!=b||a.y!=c||a.width!=d||a.height!=e}},{key:'fixOverlappingPositions',value:function(a,b){var c=this,d=this.maxMoveIterations,e=this.allowFallbackResize;this.maxMoveIterations=a,this.allowFallbackResize=b,this.nodes.some(function(a){if(!c.isAreaEmpty(a.x,a.y,a.width,a.height,a))return c.moveNode(a,a.x,a.y,a.width,a.height)}),this.maxMoveIterations=d,this.allowFallbackResize=e}},{key:'cloneGrid',value:function(b){b||(b=function(a){return Object.assign({},a)});var c=new a({width:this.width,height:this.height,maxMoveIterations:this.maxMoveIterations,allowFallbackResize:this.allowFallbackResize},this.nodes.map(b));return c}},{key:'saveUpdate',value:function(){this.nodes.forEach(function(a){a._origX=a.x,a._origY=a.y,a._origWidth=a.width,a._origHeight=a.height})}},{key:'revertUpdate',value:function(){this.nodes.forEach(function(a){a.x=a._origX,a.y=a._origY,a.width=a._origWidth,a.height=a._origHeight}),this.onNodePositionChange()}},{key:'onNodePositionChange',value:function(){}},{key:'triggerChangeEvent',value:function(a){var b=[];a&&b.push(a);var c=b.concat(this.getDirtyNodes());this.onchange(c)}},{key:'setNewPosition',value:function(a,b,c,d,e){if(a){if(!this.isNodeChangedPosition(a,b,c,d,e))return!0;if(!this.isPositionValid(b,c,d,e))return!1;var f=a.width!=d||a.height!=e;return a._dirty=!0,a.x=b,a.y=c,a.width=d,a.height=e,a=this._prepareNode(a,f),this.onNodePositionChange(),!0}}},{key:'getChangesForMove',value:function(a,b,c,d,e){var f,g;g=this.cloneGrid(function(a){var b=Object.assign({},a);return b.x=a._origX,b.y=a._origY,b.width=a._origWidth,b.height=a._origHeight,b}),f=g.nodes.find(function(b){return b.id===a.id});var h=null,i=g._findPos(a,b,c,d,e);return null===i&&g.allowFallbackResize&&(i=g._resizeToFreeSpaceForNode(f,b,c,d,e)),i&&(h=[],this.nodes.forEach(function(a){var b=i.grid.nodes.find(function(b){return b.id===a.id});b&&h.push({id:a.id,x:b.x,y:b.y,width:b.width,height:b.height})})),h}},{key:'_resizeToFreeSpaceForNode',value:function(a,c,d,e,f){var g=null,h=this.whatIsHere(c,d,e,f).filter(function(b){return a.id!==b.id});if(1===h.length){var i=h[0],j=0,k=0;if(k=i.y<d?d-i.y:b(0,i.y+i.height-(d+f)),j=i.x<c?c-i.x:b(0,i.x+i.width-(c+e)),0<j||0<k){var l=(i.width-j)*i.height,m=(i.height-k)*i.width;m<l?(i.height=k,i.y>=d&&(i.y=d+f)):(i.width=j,i.x>=c&&(i.x=c+e)),a.x=c,a.y=d,a.width=e,a.height=f,this.isPositionValid(i.x,i.y,i.width,i.height)&&(g={grid:this})}}return g}},{key:'_findPos',value:function(a,b,c,d,e){var f=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[];if(this.maxMoveIterations<=f.length)return null;if(!this.isPositionValid(b,c,d,e))return!1;var g=this.cloneGrid(),h=g.nodes.find(function(b){return b.id===a.id});h||(h=g.addNode(Object.assign({},a)));var i=g.setNewPosition(h,b,c,d,e);if(i){var j=f.slice();j.push(h.id);var k=g._fixCollisions(h,j);return k}return null}},{key:'_fixCollisions',value:function(a){for(var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],c=null,d=[],e=void 0,f=void 0;;){if(e=this.whatIsHere(a.x,a.y,a.width,a.height),f=e.find(function(b){return!d.includes(b)&&a.id!==b.id}),!f){c||(c=[{grid:this,moved:b}]);break}if(this.maxMoveIterations<=b.length)break;if(d.push(f),b.includes(f.id)){c=null;break}if(c?function(){var b=[];c.forEach(function(c){var d=c.grid.nodes.find(function(a){return a.id===f.id}),e=c.grid.nodes.find(function(b){return b.id===a.id}),g=[];d&&e&&(g=c.grid._getValidMovesForCollisionNodeAwayFromNode(d,e,c.moved)),g.forEach(function(a){b.push(a)})}),c=b}():c=this._getValidMovesForCollisionNodeAwayFromNode(f,a,b),!c.length)break}var g=null;if(c&&c.length){g=c[0];for(var h=1;h<c.length;h++)c[h].moved.length<g.moved.length&&(g=c[h])}return g}},{key:'_getValidMovesForCollisionNodeAwayFromNode',value:function(a,b,c){var d=[],e=this._findPos(a,a.x,b.y+b.height,a.width,a.height,c),f=this._findPos(a,a.x,b.y-a.height,a.width,a.height,c),g=this._findPos(a,b.x+b.width,a.y,a.width,a.height,c),h=this._findPos(a,b.x-a.width,a.y,a.width,a.height,c);return e&&d.push(e),f&&d.push(f),g&&d.push(g),h&&d.push(h),d}},{key:'_prepareNode',value:function(a,b){return a.x=parseInt(a.x,10),a.y=parseInt(a.y,10),a.width=parseInt(a.width,10)||1,a.height=parseInt(a.height,10)||1,a.noResize=!!a.noResize,a.noMove=!!a.noMove,a.width>this.width?a.width=this.width:1>a.width&&(a.width=1),a.height>this.height?a.height=this.height:1>a.height&&(a.height=1),a.x+a.width>this.width&&(b?a.width=this.width-a.x:a.x=this.width-a.width),0>a.x&&(a.x=0),a.y+a.height>this.height&&(b?a.height=this.height-a.y:a.y=this.height-a.height),0>a.y&&(a.y=0),a}}]),a}(),f=function(){function b(a){c(this,b),this.grid=a}return d(b,[{key:'resizable',value:function(b,c){var d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return b=a(b),'disable'===c||'enable'===c?b.resizable(c):'option'===c?b.resizable(c,d,e):b.resizable(Object.assign({},this.grid.opts.resizable,{handles:b.data('gb-resize-handles')||this.grid.opts.resizable.handles,start:c.start||function(){},stop:c.stop||function(){},resize:c.resize||function(){}})),this}},{key:'draggable',value:function(b,c){return b=a(b),'disable'===c||'enable'===c?b.draggable(c):b.draggable(Object.assign({},this.grid.opts.draggable,{containment:null,start:c.start||function(){},stop:c.stop||function(){},drag:c.drag||function(){}})),this}},{key:'droppable',value:function(b,c){return b=a(b),'disable'===c||'enable'===c?b.droppable(c):b.droppable({accept:c.accept}),this}},{key:'isDroppable',value:function(b){return b=a(b),!!b.data('droppable')}},{key:'on',value:function(b,c,d){return a(b).on(c,d),this}}]),b}(),g={Stylesheet:{create:function(a){var b=document.createElement('style');return b.type='text/css',b.setAttribute('data-gb-style-id',a),b.appendChild(document.createTextNode(' ')),document.getElementsByTagName('head')[0].appendChild(b),b.sheet},remove:function(b){a('STYLE[data-gb-style-id='+b+']').remove()},insertCSSRule:function(a,b,c,d){a.insertRule(b+'{'+c+'}',d)}},throttle:function(a,b){var c,d=Date.now();return b=b||1e3,c=function(){var c=Date.now();c-d>=b&&(a(),d=c)},c},removePositioningStyles:function(a){var b=a[0].style;b.position&&b.removeProperty('position'),b.left&&b.removeProperty('left'),b.top&&b.removeProperty('top'),b.width&&b.removeProperty('width'),b.height&&b.removeProperty('height')}},h=function(){function h(b){var d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};c(this,h);var g=this;this.container=a(b),this.baseClass='gridboard-',this.containerClass=this.baseClass+'instance-'+(1e4*Math.random()).toFixed(),this.itemClass=this.baseClass+'item',this.placeholderClass=this.baseClass+'item-placeholder',this.dataPrefix='data-gb-',this.opts=Object.assign({staticGrid:!1,animate:!0,minWidth:768,maxMoveIterations:4,allowFallbackResize:!1,resizable:Object.assign({handles:'e, se, s, sw, w, nw, n, ne'},d.resizable),draggable:Object.assign({scroll:!1,appendTo:'body'},d.draggable)},d),this.container.addClass(this.containerClass),this.container.toggleClass(this.baseClass+'static',!!this.opts.staticGrid),this.dd=new f(this),!this.opts.staticGrid&&this.opts.acceptDraggables&&this._bindExternalDragNDropHandler(),this.grid=new e({width:this.opts.width,height:this.opts.height,maxMoveIterations:this.opts.maxMoveIterations,allowFallbackResize:this.opts.allowFallbackResize},[],function(a){a.forEach(function(a){null===a.id?a.el&&a.el.remove():g.setElAttributes(a.el,{x:a.x,y:a.y,width:a.width,height:a.height})})}),this._setCellSize(),this.container.children('.'+this.itemClass+':not(.'+this.placeholderClass+')').each(function(a,b){g._prepareElement(b)}),this._setAnimation(this.opts.animate),this.placeholder=a('<div class="`${this.placeholderClass}` `${this.itemClass}`"><div class="placeholder-content"></div></div>').hide(),this._bindResizeHandler()}var i=Math.round,j=Math.floor;return d(h,[{key:'addElement',value:function(b,c,d,e,f,g,h,i,j,k){return b=a(b),this.setElAttributes(b,{x:c,y:d,width:e,height:f,minWidth:g,maxWidth:h,minHeight:i,maxHeight:j,id:k}),this.container.append(b),this._prepareElement(b),this._triggerChangeEvent(!0),b}},{key:'removeElement',value:function(b,c){b=a(b);var d=b.data(this.dataPrefix+'node');this.grid.removeNode(d),b.removeData(this.dataPrefix+'node'),c&&b.remove(),this._triggerChangeEvent(!0)}},{key:'setElAttributes',value:function(a,b){if(a){var c={};'undefined'!=typeof b.x&&(c[this.dataPrefix+'x']=b.x),'undefined'!=typeof b.y&&(c[this.dataPrefix+'y']=b.y),'undefined'!=typeof b.width&&(c[this.dataPrefix+'width']=b.width),'undefined'!=typeof b.height&&(c[this.dataPrefix+'height']=b.height),'undefined'!=typeof b.minWidth&&(c[this.dataPrefix+'min-width']=b.minWidth),'undefined'!=typeof b.maxWidth&&(c[this.dataPrefix+'max-width']=b.maxWidth),'undefined'!=typeof b.minHeight&&(c[this.dataPrefix+'min-height']=b.minHeight),'undefined'!=typeof b.maxHeight&&(c[this.dataPrefix+'max-height']=b.maxHeight),'undefined'!=typeof b.id&&(c[this.dataPrefix+'id']=b.id),a.attr(c)}}},{key:'destroy',value:function(){var a=this,b=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0];this.container.off('resize',this.onResize),this._setMoveEvents(!1),this._setResizeEvents(!1),b?this.container.remove():(this.grid.nodes.forEach(function(b){return a.removeElement(b.el)}),this.grid.nodes=[],this.container.removeData('gridboard')),g.Stylesheet.remove(this._stylesId),this.grid&&(this.grid=null)}},{key:'getCellFromAbsolutePixel',value:function(a){var b=this.container.offset(),c=this.container.position();return a={left:a.left-b.left+c.left,top:a.top-b.top+c.top},this._getCellFromPixel(a)}},{key:'_getCellFromPixel',value:function(a,b){var c=b?this.container.offset():this.container.position(),d=a.left-c.left,e=a.top-c.top,f=j(this.container.width()/this.opts.width),g=j(this.container.height()/this.opts.height);return{x:j(d/f),y:j(e/g)}}},{key:'_setCellSize',value:function(){var a=i(this.container.width()/this.opts.width);a&&(this.cellWidth=a);var b=i(this.container.height()/this.opts.height);b&&(this.cellHeight=b,this._updateStyles())}},{key:'_updateStyles',value:function(){this._stylesId&&g.Stylesheet.remove(this._stylesId),this._stylesId='gridboard-style-'+(1e5*Math.random()).toFixed();var a,b=this,c='.'+this.containerClass+' .'+this.itemClass,d=g.Stylesheet.create(this._stylesId);a=function(a){return b.cellHeight*a+'px'},g.Stylesheet.insertCSSRule(d,c,'min-height: '+a(1,0)+';',0);for(var e=0;e<this.opts.height;e++)g.Stylesheet.insertCSSRule(d,c+'['+this.dataPrefix+'height="'+(e+1)+'"]','height: '+a(e+1,e)+';',e),g.Stylesheet.insertCSSRule(d,c+'['+this.dataPrefix+'min-height="'+(e+1)+'"]','min-height: '+a(e+1,e)+';',e),g.Stylesheet.insertCSSRule(d,c+'['+this.dataPrefix+'max-height="'+(e+1)+'"]','max-height: '+a(e+1,e)+';',e),g.Stylesheet.insertCSSRule(d,c+'['+this.dataPrefix+'y="'+e+'"]','top: '+a(e,e)+';',e)}},{key:'_bindNodeDragNDropNResizeHandler',value:function(b,c){var d,e,f,h=this;d=function(a,b){var d,e,f=i(b.position.left/h.cellWidth),g=j((b.position.top+h.cellHeight/2)/h.cellHeight);'resize'===a.type?(d=i(b.size.width/h.cellWidth),e=i(b.size.height/h.cellHeight)):(d=c.width,e=c.height),'drag'===a.type&&!h.grid.isPositionValid(f,g,d,e)||'resize'===a.type&&(0>f||0>g)||h.grid.moveNode(c,f,g,d,e)},e=function(d,e){h.container.append(h.placeholder);var f=a(this);h.grid.cleanNodes(),h.grid.saveUpdate(),h.setElAttributes(h.placeholder,{x:f.attr(h.dataPrefix+'x'),y:f.attr(h.dataPrefix+'y'),width:f.attr(h.dataPrefix+'width'),height:f.attr(h.dataPrefix+'height')}),h.placeholder.show(),c.el=h.placeholder,h.dd.resizable(b,'option','minWidth',h.cellWidth*(c.minWidth||1)),h.dd.resizable(b,'option','minHeight',h.cellHeight*(c.minHeight||1)),'function'==typeof h.opts.draggable.start&&h.opts.draggable.start(d,e)},f=function(){var b=a(this);b.data(h.dataPrefix+'node')&&(h.placeholder.detach(),h.placeholder.hide(),c.el=b,g.removePositioningStyles(b),h.setElAttributes(b,{x:c.x,y:c.y,width:c.width,height:c.height}),h._triggerChangeEvent(),h.grid.saveUpdate())},this.dd.draggable(b,{start:e,stop:f,drag:d}).resizable(b,{start:e,stop:f,resize:d}),(this.opts.staticGrid||this._isOneColumnMode())&&(this.dd.draggable(b,'disable'),this.dd.resizable(b,'disable'))}},{key:'_triggerChangeEvent',value:function(a){var b=this.grid.getDirtyNodes(),c=[],d=!1;b&&b.length&&(c.push(b),d=!0),(d||a)&&this.container.trigger('change',c)}},{key:'_isOneColumnMode',value:function(){return this.opts.minWidth&&a(window).width()<=this.opts.minWidth}},{key:'_setAnimation',value:function(a){var b=this.baseClass+'animate';this.container.toggleClass(b,a)}},{key:'_prepareElement',value:function(b){var c=this;b=a(b),b.addClass(this.itemClass);var d=function(a,b){return a.attr(c.dataPrefix+b)},e=function(a,b){return parseInt(d(a,b),10)},f={x:e(b,'x'),y:e(b,'y'),width:e(b,'width')||1,height:e(b,'height')||1,maxWidth:e(b,'max-width')||this.opts.width,minWidth:e(b,'min-width')||1,maxHeight:e(b,'max-height')||this.opts.height,minHeight:e(b,'min-height')||1,resizeHandles:d(b,'resize-handles'),el:b,id:d(b,'id'),_grid:this};if(!this.grid.isAreaEmpty(f.x,f.y,f.width,f.height)){var g=this.grid.findFreeSpace(f.width,f.height);if(g||(g=this.grid.findFreeSpace(1,1)),g)f.x=g.x,f.y=g.y,f.width=g.w,f.height=g.h;else return}var h=this.grid.addNode(f);b.data(this.dataPrefix+'node',h),this._bindNodeDragNDropNResizeHandler(b,h)}},{key:'_setMoveEvents',value:function(b){var c=this,d=!b||c._isOneColumnMode();return a(this.container.children('.'+this.itemClass)).each(function(b,e){e=a(e);var f=e.data(c.dataPrefix+'node');f&&(c.dd.draggable(e,d?'disable':'enable'),e.toggleClass('ui-draggable-handle',!d))}),this}},{key:'_setResizeEvents',value:function(b){var c=this,d=!b||c._isOneColumnMode();return a(this.container.children('.'+this.itemClass)).each(function(b,e){e=a(e);var f=e.data(c.dataPrefix+'node');f&&c.dd.resizable(e,d?'disable':'enable')}),this}},{key:'_bindResizeHandler',value:function(){var a=this,b=a._isOneColumnMode();this.onResize=g.throttle(function(){a._setCellSize();var c=a._isOneColumnMode();if(b!==c){if(b=c,a.container.toggleClass('gridboard-one-column-mode',b),a.opts.staticGrid)return;b?(this._setMoveEvents(!1),this._setResizeEvents(!1)):(this._setMoveEvents(!0),this._setResizeEvents(!0))}},200),this.container.on('resize',this.onResize)}},{key:'_bindExternalDragNDropHandler',value:function(){var c,d=this,e=null;c=function(a){var c=e,f=c.data(d.dataPrefix+'node'),g=d._getCellFromPixel({left:a.pageX,top:a.pageY},!0),h=b(0,g.x),i=b(0,g.y);if(!f._added){if(f.el=c,f.x=h,f.y=i,!d.grid.canAddNode(f))return;f._added=!0,d.grid.cleanNodes(),d.grid.saveUpdate(),d.grid.addNode(f),d.container.append(d.placeholder),d.setElAttributes(d.placeholder,{x:f.x,y:f.y,width:f.width,height:f.height}),d.placeholder.show(),f.el=d.placeholder}d.grid.moveNode(f,h,i,f.width,f.height)},this.dd.droppable(d.container,{tolerance:'touch',accept:function(b){return a(b).is(d.opts.acceptDraggables)}}).on(d.container,'dropover',function(b,f){d.grid.saveUpdate();var g=a(f.draggable),h=parseInt(g.attr('data-width'),10)||1,i=parseInt(g.attr('data-height'),10)||1;e=g;var j=d.grid._prepareNode({width:h,height:i,_added:!1});g.data(d.dataPrefix+'node',j),g.on('drag',c)}).on(d.container,'dropout',function(b,e){d.grid.revertUpdate();var f=a(e.draggable),g=f.data(d.dataPrefix+'node');g&&(g.el=null,d.grid.removeNode(g)),f.unbind('drag',c),d.placeholder.detach()}).on(d.container,'drop',function(b,e){var f=a(e.draggable).data(d.dataPrefix+'node');d.placeholder.detach(),f&&(f.el=null,d.grid.removeNode(f)),d._triggerChangeEvent(),d.grid.saveUpdate(),a(e.draggable).unbind('drag',c),a(e.draggable).removeData(d.dataPrefix+'node'),d.container.trigger('dropped',[null,f,e])})}}]),h}();h.Engine=e,window.GridBoard=h,a.fn.gridboard=function(b){return this.each(function(){var c=a(this);c.data('gridboard')||c.data('gridboard',new h(this,b))})}})($)})();
